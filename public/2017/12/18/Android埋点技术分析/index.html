<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,SDK,埋点,无埋点,可视化埋点," />





  <link rel="alternate" href="/atom.xml" title="UncleChen的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="一、概念埋点，是对网站、App或者后台等应用程序进行数据采集的一种方法。通过埋点，可以收集用户在应用中的产生行为，进而用于分析和优化产品后续的体验，也可以为产品的运营提供数据支撑，其中常见的指标有PV、UV、页面时长和按钮的点击等，通常可以采集到下面这些数据。  行为数据：时间、地点、人物、交互的内容等 质量数据：Ap">
<meta name="keywords" content="Android,SDK,埋点,无埋点,可视化埋点">
<meta property="og:type" content="article">
<meta property="og:title" content="Android埋点技术分析">
<meta property="og:url" content="http://unclechen.github.io/2017/12/18/Android埋点技术分析/index.html">
<meta property="og:site_name" content="UncleChen的博客">
<meta property="og:description" content="一、概念埋点，是对网站、App或者后台等应用程序进行数据采集的一种方法。通过埋点，可以收集用户在应用中的产生行为，进而用于分析和优化产品后续的体验，也可以为产品的运营提供数据支撑，其中常见的指标有PV、UV、页面时长和按钮的点击等，通常可以采集到下面这些数据。  行为数据：时间、地点、人物、交互的内容等 质量数据：App运行情况、浏览器加载情况、错误异常等 环境数据：手机型号、操作系统版本、浏览器">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006tKfTcly1fn1f3fcrrkj30rs06twfj.jpg">
<meta property="og:updated_time" content="2018-05-13T07:13:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android埋点技术分析">
<meta name="twitter:description" content="一、概念埋点，是对网站、App或者后台等应用程序进行数据采集的一种方法。通过埋点，可以收集用户在应用中的产生行为，进而用于分析和优化产品后续的体验，也可以为产品的运营提供数据支撑，其中常见的指标有PV、UV、页面时长和按钮的点击等，通常可以采集到下面这些数据。  行为数据：时间、地点、人物、交互的内容等 质量数据：App运行情况、浏览器加载情况、错误异常等 环境数据：手机型号、操作系统版本、浏览器">
<meta name="twitter:image" content="https://ws1.sinaimg.cn/large/006tKfTcly1fn1f3fcrrkj30rs06twfj.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":true,"scrollpercent":true},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '9GQE7B6UON',
      apiKey: '1b6c2bb25ddee8d24221b1df179afbde',
      indexName: 'UncleChenBlog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"输入关键词进行搜索","hits_empty":"找不到关于“${query}”的文章","hits_stats":"找到 ${hits} 篇文章，耗时 ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://unclechen.github.io/2017/12/18/Android埋点技术分析/"/>





  <title>Android埋点技术分析 | UncleChen的博客</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c7b0eb7b32d0e8723fcb885bc9778590";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">UncleChen的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <div class="post-block" style="opacity: 1; display: block;">
    <link itemprop="mainEntityOfPage" href="http://unclechen.github.io/2017/12/18/Android埋点技术分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="unclechen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UncleChen的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android埋点技术分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-18T08:00:00+08:00">
                2017-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2017/12/18/Android埋点技术分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h1><p>埋点，是对网站、App或者后台等应用程序进行数据采集的一种方法。通过埋点，可以收集用户在应用中的产生行为，进而用于分析和优化产品后续的体验，也可以为产品的运营提供数据支撑，其中常见的指标有PV、UV、页面时长和按钮的点击等，通常可以采集到下面这些数据。</p>
<ul>
<li>行为数据：时间、地点、人物、交互的内容等</li>
<li>质量数据：App运行情况、浏览器加载情况、错误异常等</li>
<li>环境数据：手机型号、操作系统版本、浏览器UA、地理、运营商、网络环境等</li>
<li>运营数据：PV、UV、点击量、日活、留存、渠道来源等</li>
</ul>
<p>采集行为数据时，通常需要在Web页面/App里面添加一些代码，当用户的行为达到某种条件时，就会向服务器上报用户的行为。其实添加这些代码的过程就可以叫做“埋点”，在很久以前就已经出现了这种技术。随着技术的发展和大家对数据采集要求的不断提高，我认为埋点的技术方案走过了下面几个阶段：</p>
<ul>
<li><p><strong>代码埋点：代码埋点是指在某个事件发生时调用数据发送接口上报数据。</strong>例如开发人员按照产品/运营的需求，在Web页面/App的源码里面添加行为上报的代码，当用户的行为满足某一个条件时，这些代码就会被执行，向服务器上报行为数据。这种方案是最基础的方案，每次增加或者修改数据上报的条件，都需要开发人员的参与，并且只能在下一个版本上线后才能看到效果。基本上所有的数据平台都提供了这类数据上报的SDK，将行为上报的后台服务器接口封装成了简单的客户端SDK接口。开发者可以通过嵌入这类SDK，在埋点的地方调用少量的代码就可以上报行为数据。</p>
</li>
<li><p><strong>全埋点：全埋点指的是将Web页面/App内产生的所有的、满足某个条件的行为，全部上报到后台服务器。</strong>例如把一个App中所有的按钮点击都进行上报，然后由产品/运营去后台筛选所需要的行为数据。这种方案的优点非常明显，就是可以不用在新增/修改行为上报条件时，再找开发人员去修改埋点的代码。然而它的缺点也和优点一样明显，那就是上报的数据量比代码埋点大很多，里面可能很多是没有价值的数据。此外，这种方案更倾向于独立去看待用户的行为，而没有关注行为的上下文，给数据分析带来了一些难度。很多公司也提供了这类功能的SDK，通过静态或者动态的方式，<strong>“Hook”了原有的App代码</strong>，从而实现了行为的监测，在数据上报时通常是采用累积多条再上报的方案来合并请求。</p>
</li>
<li><p><strong>可视化埋点：可视化埋点是指通过可视化工具配置采集节点，在App/Web解析配置查找节点，监听节点产生的事件并上报。</strong>例如产品在Web页面/App的界面上进行圈选，配置需要监测界面上哪一个元素，然后保存这个配置，当App启动时会从后台服务器获得产品/运营预先圈选好的配置，然后根据这份配置查找并监测App界面上的元素，当某一个元素满足条件时，就会上报行为数据到后台服务器。有了暴力的全埋点技术方案，很容易联想到按需埋点，可视化埋点就是一种按需配置埋点的方案。现在也有一些公司提供了这类SDK，圈选监测元素时，有的是提供一个Web管理界面，手机在安装并初始化了SDK之后，可以和管理界面了连接，让用户在Web管理界面上配置需要监测的元素，有的是直接让用户在手机上圈选元素进行埋点。</p>
</li>
</ul>
<blockquote>
<p>hook直译是钩子的意思，以前学信息安全的时候在windows上听到过，大体意思是通过某种手段去改变系统API的一个行为，绕过系统的某个方法，或者改变系统的工作流程。在这里其实是指把本来要执行某个方法的对象替换成另一个，一般用的是反射或者代理，需要找到hook的代码位置，甚至还可以在编译阶段实现替换。全埋点和可视化埋点都需要Hook掉App原本的代码实现。</p>
</blockquote>
<p>业界有多家SDK都支持上面介绍的3种埋点方案中的一种或者全部，例如Mixpanel、Sensorsdata、TalkingData、GrowingIO、诸葛IO、Heap Analytics、MTA、Umeng Analytics、百度，只是大家对后两种埋点的称呼不完全相同，有的叫无埋点或者codeless埋点。由于<a href="https://github.com/mixpanel/mixpanel-android" target="_blank" rel="noopener">Mixpanel</a>（支持代码埋点、可视化埋点）和<a href="https://github.com/sensorsdata/sa-sdk-android" target="_blank" rel="noopener">Sensorsdata</a>（全部支持）都开源了自己的全部SDK，技术方案也比较类似，下面以它们的Android SDK为例，简单分析一下3种埋点方案的技术实现。关于JS的SDK技术实现，可以看下我的另一篇博客-<a href="http://unclechen.github.io/2017/12/24/JS%E5%9F%8B%E7%82%B9SDK%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">JS埋点SDK技术分析</a>。</p>
<a id="more"></a>
<h1 id="二、代码埋点"><a href="#二、代码埋点" class="headerlink" title="二、代码埋点"></a>二、代码埋点</h1><p>包含Mixpanel SDK在内的大部分SDK，都会把这种埋点方案封装成一个比较简单的接口，在这里是<code>track(String eventName, JSONObject properties)</code>，开发者在调用这个接口时，可以把一个事件名称和事件的属性传入，然后就可以上报到后台了。一般代码埋点长这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 业务代码</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 埋点上报</span></span><br><span class="line">    JSONObject properties = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    properties.put(<span class="string">"price"</span>, <span class="number">6800</span>);</span><br><span class="line">    properties.put(<span class="string">"name"</span>, <span class="string">"Pixel2 XL"</span>);</span><br><span class="line">    Tracker.track(<span class="string">"PURCHASE"</span>, properties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>Mixpanel SDK内部采用一条HandlerThread线程来处理事件，当开发者调用<code>track(String eventName, JSONObject properties)</code>方法时，<strong>主线程切换到HandlerThread</strong>当中，并先将事件存入数据库。然后看SDK中是否累计到了40个事件，如果累计到40个事件的话，就合并它们上报到后台。</p>
<p>当开发者设置为debug模式，或者手动调用<code>flush</code>接口时，可以立即上报累计的所有事件，不过由于只有一条线程，所以如果在flush的时候，前面的事件还没有处理完成，SDK会间隔1分钟再次去处理后面的这些事件。</p>
<p>开发者可以设置累计上报的事件数量阈值、事件阻塞时再次尝试上报的时间间隔等。这种方案比较基础，相信大部分开发者都接触过，不需要过多分析。</p>
<h1 id="三、全埋点"><a href="#三、全埋点" class="headerlink" title="三、全埋点"></a>三、全埋点</h1><h2 id="3-1-基本原理"><a href="#3-1-基本原理" class="headerlink" title="3.1 基本原理"></a>3.1 基本原理</h2><p>全埋点要对方法进行Hook，按照<strong>是否在运行时</strong>这个条件来区分，Android全埋点可以有下面两种方式：</p>
<ul>
<li><strong>静态Hook：</strong>AspectJ实现AOP，编译期修改代码</li>
<li><strong>动态Hook：</strong>运行时替换View.OnClickListener等事件回调</li>
</ul>
<p>这里的Hook其实就是一种AOP实现。</p>
<blockquote>
<p>那么什么是AOP？AOP为Aspect Oriented Programming的缩写，意为：面向切面编程，通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。AOP是OOP的延续，是软件开发中的一个热点，也是Spring框架中的一个重要内容，是函数式编程的一种衍生范型。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。（from baidu baike）</p>
<p>简而言之，AOP是可以通过预编译方式和运行期动态代理实现在不修改源代码的情况下给程序动态统一添加功能的一种技术。</p>
</blockquote>
<p><strong>Sensors Analytics AndroidSDK全埋点的实现就是通过在代码编译阶段，找到源代码中需要上报事件的位置，插入SDK的事件上报代码。它用到的框架是<a href="https://www.eclipse.org/aspectj/" target="_blank" rel="noopener">AspectJ</a>。</strong></p>
<h2 id="3-2-使用AspectJ做静态Hook"><a href="#3-2-使用AspectJ做静态Hook" class="headerlink" title="3.2 使用AspectJ做静态Hook"></a>3.2 使用AspectJ做静态Hook</h2><h3 id="3-2-1-AspectJ基本概念"><a href="#3-2-1-AspectJ基本概念" class="headerlink" title="3.2.1 AspectJ基本概念"></a>3.2.1 AspectJ基本概念</h3><p>在很多地方我们可以看到AspectJ的身影，例如JakeWharton大神贡献的一个注解日志和性能调优框架<a href="https://github.com/JakeWharton/hugo" target="_blank" rel="noopener">Hugo</a>，在Spring框架里面也有应用到AspectJ的概念（不过Spring AOP的实现是用的动态代理）。我理解AspectJ里面的主要几个概念有：</p>
<ul>
<li><strong>JPoint：</strong>代码切点（就是我们要插入代码的地方）</li>
<li><strong>Aspect：</strong>代码切点的描述<ul>
<li><strong>Pointcut：</strong>描述切点具体是什么样的点，如函数被调用的地方（<code>Call(MethodSignature)</code>）、函数执行的内部（<code>execution(MethodSignature)</code>）</li>
<li><strong>Advice：</strong>描述在切点的什么位置插入代码，如在Pointcut前面（<code>@Before</code>）还是后面（<code>@After</code>），还是环绕整个Pointcut（<code>@Around</code>）</li>
</ul>
</li>
</ul>
<p>由此可见，在实现AOP功能时，需要做下面几件事：</p>
<ul>
<li>定义一个Aspect，这个Aspect里面必须有Pointcut和Advice两个属性</li>
<li>编写在匹配到符合Pointcut和Advice描述的代码时，需要注入的代码</li>
<li>在代码编译时，通过特殊的java编译器（Aspect的ajc编译器），找到符合我们定义的Aspect的代码，将需要注入的代码插入到Advice指定的位置。</li>
</ul>
<p>如果你对AspectJ有了解的话，已经可以猜到SDK内部是怎么实现全埋点的了；如果没有接触，我觉得也不用急于全面地去学习AspectJ，毕竟AspectJ的功能很强大（可远不止前置、后置这么简单的增强），埋点这种业务只用到了AspectJ当中的一小部分功能而已，可以直接看下面的分析。</p>
<h3 id="3-2-2-实现"><a href="#3-2-2-实现" class="headerlink" title="3.2.2 实现"></a>3.2.2 实现</h3><p>神策SDK里面是如何监测View点击事件呢？我把SDK代码简化一下进行分析，有下面几个步骤：</p>
<h4 id="3-2-2-1-定义一个Aspect"><a href="#3-2-2-1-定义一个Aspect" class="headerlink" title="3.2.2.1 定义一个Aspect"></a>3.2.2.1 定义一个Aspect</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewOnClickListenerAspectj</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * android.view.View.OnClickListener.onClick(android.view.View)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint JoinPoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"execution(* android.view.View.OnClickListener.onClick(android.view.View))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewClickAOP</span><span class="params">(<span class="keyword">final</span> JoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        AopUtil.sendTrackEventToSDK(joinPoint, <span class="string">"onViewOnClick"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段Aspect的代码定义了：<strong>在执行android.view.View.OnClickListener.onClick(android.view.View)方法原有的实现后面，需要插入<code>AopUtil.sendTrackEventToSDK(joinPoint, &quot;onViewOnClick&quot;);</code>这段代码。</strong></p>
<p><code>AopUtil.sendTrackEventToSDK(joinPoint, &quot;onViewOnClick&quot;);</code>这段代码做的事情就是点击事件的上报。因为神策SDK将全埋点功能和主SDK包分离成了两个jar包，所以通过AopUtil工具去调用真正的事件上报代码，这里不细述其实现，下面直接看这段代码背后真正的点击上报实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SensorsDataAPI.sharedInstance().track(AopConstants.APP_CLICK_EVENT_NAME, properties);</span><br></pre></td></tr></table></figure>
<p>可以看到AOP实现的点击监测，最后也走<code>track</code>方法进行上报了。</p>
<h4 id="3-2-2-2-使用ajc编译器向源代码中“织入”Aspect代码"><a href="#3-2-2-2-使用ajc编译器向源代码中“织入”Aspect代码" class="headerlink" title="3.2.2.2 使用ajc编译器向源代码中“织入”Aspect代码"></a>3.2.2.2 使用ajc编译器向源代码中“织入”Aspect代码</h4><p>采用AspectJ框架编写的代码，想要注入原来的工程的代码，需要在<code>/app/build.gradle</code>中引用ajc编译器，脚本如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> org.aspectj.bridge.IMessage</span><br><span class="line"><span class="keyword">import</span> org.aspectj.bridge.MessageHandler</span><br><span class="line"><span class="keyword">import</span> org.aspectj.tools.ajc.Main</span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'org.aspectj:aspectjtools:1.8.10'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    compile <span class="string">'org.aspectj:aspectjrt:1.8.10'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">def</span> log = project.logger</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">def</span> variants = project.android.applicationVariants</span><br><span class="line"></span><br><span class="line">variants.all &#123; variant -&gt;</span><br><span class="line">    <span class="keyword">if</span> (!variant.buildType.isDebuggable()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Skipping non-debuggable build type '$&#123;variant.buildType.name&#125;'."</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JavaCompile javaCompile = variant.javaCompile</span><br><span class="line">    javaCompile.doLast &#123;</span><br><span class="line">        String[] args = [<span class="string">"-showWeaveInfo"</span>,</span><br><span class="line">                     <span class="string">"-1.5"</span>,</span><br><span class="line">                     <span class="string">"-inpath"</span>, javaCompile.destinationDir.toString(),</span><br><span class="line">                     <span class="string">"-aspectpath"</span>, javaCompile.classpath.asPath,</span><br><span class="line">                     <span class="string">"-d"</span>, javaCompile.destinationDir.toString(),</span><br><span class="line">                     <span class="string">"-classpath"</span>, javaCompile.classpath.asPath,</span><br><span class="line">                     <span class="string">"-bootclasspath"</span>, project.android.bootClasspath.join(File.pathSeparator)]</span><br><span class="line">        log.debug <span class="string">"ajc args: "</span> + Arrays.toString(args)</span><br><span class="line"></span><br><span class="line">        MessageHandler handler = <span class="keyword">new</span> MessageHandler(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">new</span> Main().run(args, handler);</span><br><span class="line">        <span class="keyword">for</span> (IMessage <span class="string">message :</span> handler.getMessages(<span class="literal">null</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">           <span class="keyword">switch</span> (message.getKind()) &#123;</span><br><span class="line">                <span class="keyword">case</span> IMessage.<span class="string">ABORT:</span></span><br><span class="line">                <span class="keyword">case</span> IMessage.<span class="string">ERROR:</span></span><br><span class="line">                <span class="keyword">case</span> IMessage.<span class="string">FAIL:</span></span><br><span class="line">                    log.error message.message, message.thrown</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> IMessage.<span class="string">WARNING:</span></span><br><span class="line">                    log.warn message.message, message.thrown</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> IMessage.<span class="string">INFO:</span></span><br><span class="line">                    log.info message.message, message.thrown</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> IMessage.<span class="string">DEBUG:</span></span><br><span class="line">                    log.debug message.message, message.thrown</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在SensorsAndroidSDK中，把上面这段脚本编写成了一个<a href="https://github.com/sensorsdata/sa-sdk-android-plugin2" target="_blank" rel="noopener">gradle插件</a>，开发者只需要在<code>app/build.gradle</code>引用这个插件即可。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.sensorsdata.analytics.android'</span></span><br></pre></td></tr></table></figure>
<h4 id="3-2-2-3-查看织入后的class文件"><a href="#3-2-2-3-查看织入后的class文件" class="headerlink" title="3.2.2.3 查看织入后的class文件"></a>3.2.2.3 查看织入后的class文件</h4><p>完成上面两步，就可以实现在<code>android.view.View.OnClickListener.onClick(android.view.View)</code>方法中插入我们的数据上报代码了。我们在demo代码中加一个Button，并给它set一个OnClickListener，编译一下代码，查看<code>/build/intermediates/classes/debug/</code>里面class文件，经过ajc编译之后，原始代码中插入了Aspect的代码，并调用了<code>ViewOnClickListenerAspectj</code>里面的<code>onViewClickAOP</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(<span class="number">2130968603</span>);</span><br><span class="line">        Button btnTst = (Button)<span class="keyword">this</span>.findViewById(<span class="number">2131427422</span>);</span><br><span class="line">        btnTst.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                JoinPoint var2 = Factory.makeJP(ajc$tjp_0, <span class="keyword">this</span>, <span class="keyword">this</span>, v);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Log.i(<span class="string">"MainActivity"</span>, <span class="string">"button clicked"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                    ViewOnClickListenerAspectj.aspectOf().onViewClickAOP(var2);</span><br><span class="line">                    <span class="keyword">throw</span> var5;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ViewOnClickListenerAspectj.aspectOf().onViewClickAOP(var2);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">static</span> &#123;</span><br><span class="line">                ajc$preClinit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AspectJ的基本用法就是这样，除了对<code>OnClickListener</code>进行替换，理论上可以对任何已知的方法进行替换，所以在埋点SDK中还可以采用对RatingBar、CheckBox、RadioButton等控件的点击进行监听。</p>
<p>神策AndroidSDK借助AspectJ插入Aspect代码，就是一种静态Hook的方式。本质上是在程序没有运行之前，通常是编译或者链接的阶段，对字节码进行修改，插入事件上报的代码。</p>
<p>修改字节码除了这种方案之外，还有Android Gradle插件提供的trasform api（1.5.0版本以上）、ASM、Javassist。在网易乐得的埋点方案，Nuwa热修复项目都可以见到这些技术的实践。</p>
<h2 id="3-3-使用代理模式实现动态Hook"><a href="#3-3-使用代理模式实现动态Hook" class="headerlink" title="3.3 使用代理模式实现动态Hook"></a>3.3 使用代理模式实现动态Hook</h2><h3 id="3-3-1-代理模式"><a href="#3-3-1-代理模式" class="headerlink" title="3.3.1 代理模式"></a>3.3.1 代理模式</h3><p>上面分析了以AspectJ为代表的<strong>“静态Hook”</strong>实现方案，有没有其他办法可以不修改源代码，只是<strong>在App运行的时候去“动态Hook”</strong>点击行为的处理呢？答案是肯定的，JAVA里面有一个设计模式叫代理模式，从这个角度出发，看下怎么<strong>在运行时</strong>实现点击事件的监测上报。</p>
<p>在<a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/view/View.java" target="_blank" rel="noopener">android.view.View.java</a>的源码（<code>API&gt;=14</code>）中，有这么几个关键的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getListenerInfo方法：返回所有的监听器信息mListenerInfo</span></span><br><span class="line"><span class="function">ListenerInfo <span class="title">getListenerInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mListenerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mListenerInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    mListenerInfo = <span class="keyword">new</span> ListenerInfo();</span><br><span class="line">    <span class="keyword">return</span> mListenerInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听器信息</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerInfo</span> </span>&#123;</span><br><span class="line">    ... <span class="comment">// 此处省略各种xxxListener</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Listener used to dispatch click events.</span></span><br><span class="line"><span class="comment">     * This field should be made private, so it is hidden from the SDK.</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> OnClickListener mOnClickListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Listener used to dispatch long click events.</span></span><br><span class="line"><span class="comment">     * This field should be made private, so it is hidden from the SDK.</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> OnLongClickListener mOnLongClickListener;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">ListenerInfo mListenerInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们非常熟悉的方法，内部其实是把mListenerInfo的mOnClickListener设成了我们创建的OnclickListner对象</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(@Nullable OnClickListener l)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isClickable()) &#123;</span><br><span class="line">        setClickable(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    getListenerInfo().mOnClickListener = l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断这个View是否设置了点击监听器</span></span><br><span class="line"><span class="comment"> * Return whether this view has an attached OnClickListener.  Returns</span></span><br><span class="line"><span class="comment"> * true if there is a listener, false if there is none.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasOnClickListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ListenerInfo li = mListenerInfo;</span><br><span class="line">    <span class="keyword">return</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面几个方法可以看到，点击监听器其实被保存在了<strong><code>mListenerInfo.mOnClickListener</code></strong>里面。那么实现<strong>Hook点击监听器</strong>时，只要将这个<code>mOnClickListener</code>替换成我们包装的<strong>点击监听器代理对象</strong>就可以实现点击监听的代理了。</p>
<h3 id="3-3-2-实现"><a href="#3-3-2-实现" class="headerlink" title="3.3.2 实现"></a>3.3.2 实现</h3><h4 id="3-3-2-1-创建点击监听器的代理类"><a href="#3-3-2-1-创建点击监听器的代理类" class="headerlink" title="3.3.2.1 创建点击监听器的代理类"></a>3.3.2.1 创建点击监听器的代理类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击监听器的代理类，具有上报点击行为的功能</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OnClickListenerWrapper</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 原始的点击监听器对象</span></span><br><span class="line">    <span class="keyword">private</span> View.OnClickListener onClickListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnClickListenerWrapper</span><span class="params">(View.OnClickListener onClickListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onClickListener = onClickListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 让原来的点击监听器正常工作</span></span><br><span class="line">        <span class="keyword">if</span>(onClickListener != <span class="keyword">null</span>)&#123;</span><br><span class="line">            onClickListener.onClick(view);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 点击事件上报，可以获取被点击view的一些属性</span></span><br><span class="line">        track(APP_CLICK_EVENT_NAME, getSomeProperties(view));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-2-2-反射获取一个View的mListenerInfo-mOnClickListener，替换成代理的点击监听器"><a href="#3-3-2-2-反射获取一个View的mListenerInfo-mOnClickListener，替换成代理的点击监听器" class="headerlink" title="3.3.2.2 反射获取一个View的mListenerInfo.mOnClickListener，替换成代理的点击监听器"></a>3.3.2.2 反射获取一个View的mListenerInfo.mOnClickListener，替换成代理的点击监听器</h4><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对一个View的点击监听器进行hook</span></span><br><span class="line">public void hookView(<span class="keyword">View</span> <span class="keyword">view</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 反射调用View的getListenerInfo方法（API&gt;=14），获得mListenerInfo对象</span></span><br><span class="line">    <span class="keyword">Class</span> viewClazz = <span class="keyword">Class</span>.forName(<span class="string">"android.view.View"</span>)<span class="comment">;</span></span><br><span class="line">    Method getListenerInfoMethod = viewClazz.getDeclaredMethod(<span class="string">"getListenerInfo"</span>)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">if</span> (!getListenerInfoMethod.isAccessible()) &#123;</span><br><span class="line">        getListenerInfoMethod.setAccessible(true)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    Object mListenerInfo = listenerInfoMethod.invoke(<span class="keyword">view</span>)<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 然后从mListenerInfo中反射获取mOnClickListener对象</span></span><br><span class="line">    <span class="keyword">Class</span> listenerInfoClazz = <span class="keyword">Class</span>.forName(<span class="string">"android.view.View$ListenerInfo"</span>)<span class="comment">;</span></span><br><span class="line">    Field onClickListenerField = listenerInfoClazz.getDeclaredField(<span class="string">"mOnClickListener"</span>)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">if</span> (!onClickListenerField.isAccessible()) &#123;</span><br><span class="line">        onClickListenerField.setAccessible(true)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">View</span>.OnClickListener mOnClickListener = (<span class="keyword">View</span>.OnClickListener) onClickListenerField.get(mListenerInfo)<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 创建代理的点击监听器对象</span></span><br><span class="line">    <span class="keyword">View</span>.OnClickListener mOnClickListenerWrapper = <span class="keyword">new</span> OnClickListenerWrapper(mOnClickListener)<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 把mListenerInfo的mOnClickListener设成新的onClickListenerWrapper</span></span><br><span class="line">    onClickListenerField.<span class="keyword">set</span>(mListenerInfo, mOnClickListenerWrapper)<span class="comment">;</span></span><br><span class="line">    <span class="comment">// 用这个似乎也可以：view.setOnClickListener(mOnClickListenerWrapper);     </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，如果是<code>API&lt;14</code>的话，mOnClickListener直接是直接以一个Field保存在View对象中的，没有ListenerInfo，因此反射的次数要更少一些。</p>
<h4 id="3-3-2-3-对App中所有的View进行动态Hook"><a href="#3-3-2-3-对App中所有的View进行动态Hook" class="headerlink" title="3.3.2.3 对App中所有的View进行动态Hook"></a>3.3.2.3 对App中所有的View进行动态Hook</h4><p>我们在分析的是全埋点，那么怎样把App里面所有的View点击都Hook到呢？有两种方式：</p>
<ul>
<li><p>第一种：当Activity创建完成后，开始从Activity的DecorView开始自顶向下深度遍历ViewTree，遍历到一个View的时候，对它进行hookView操作。这种方式有点暴力，由于这里面遍历ViewTree的时候用到了大量反射，性能会有影响。</p>
</li>
<li><p>第二种：比第一种方式稍微优秀一些，来源是一个Github上的开源库<a href="https://github.com/foolchen/AndroidTracker" target="_blank" rel="noopener">AndroidTracker</a>（Kotlin实现）。他的处理方式是当Activity创建完成后，在DecorView中添加一个透明的View作为子View，在这个子View的onTouchEvent方法中，根据触摸坐标找到屏幕中包含了这个坐标的View，再对这些View尝试进行hookView操作。<strong>这种方式比较取巧，首先是拿到了手指按下的位置，根据这个位置来找需要被Hook的View，避免了在遍历ViewTree的同时对View进行反射。具体实现是在遍历ViewTree中的每个View时，判断这个View的坐标是否包含手指按下的坐标，以及View是否Visible，如果满足这两个条件，就把这个View保存到一个ArrayList<view>hitViews。然后再遍历这个ArrayList里面的View，如果一个View#hasOnClickListeners返回true，那么才对他进行hookView操作。</view></strong></p>
</li>
</ul>
<h3 id="3-3-3-动态Hook小结"><a href="#3-3-3-动态Hook小结" class="headerlink" title="3.3.3 动态Hook小结"></a>3.3.3 动态Hook小结</h3><p>整体来看，动态Hook的思路这里用到了反射，难免对程序性能产生影响，如果要采用这种方式实现全埋点方案，还需要好好评估。既然提到了代理，要说一下<strong>这里的“代理模式”其实还是JAVA的静态代理</strong>，不是动态代理。因为<code>OnClickListener</code>和<code>OnClickListenerWrapper</code>是在编写代码的时候就确定了，并不是在运行时动态生成了一个<code>OnClickListenerWrapper</code>。在JDK中动态代理是使用Native去生成了代理类的字节码（比如使用ASM等工具），并使用ClassLoader加载进来的。</p>
<h2 id="3-4-全埋点参考资料"><a href="#3-4-全埋点参考资料" class="headerlink" title="3.4 全埋点参考资料"></a>3.4 全埋点参考资料</h2><ul>
<li>Aspect Oriented Programming in Android：<a href="https://fernandocejas.com/2014/08/03/aspect-oriented-programming-in-android/" target="_blank" rel="noopener">https://fernandocejas.com/2014/08/03/aspect-oriented-programming-in-android/</a></li>
<li>AOP之AspectJ全面剖析in Android（AspectJ详细用法）：<a href="http://www.jianshu.com/p/f90e04bcb326" target="_blank" rel="noopener">http://www.jianshu.com/p/f90e04bcb326</a></li>
<li>沪江开源了一个叫做AspectJX的插件，扩展了AspectJ，除了对src代码进行AOP，还支持kotlin、工程中引用的jar和aar进行AOP：<a href="https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx" target="_blank" rel="noopener">https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx</a></li>
<li>关于 Spring AOP (AspectJ) 你该知晓的一切：<a href="http://blog.csdn.net/javazejian/article/details/56267036" target="_blank" rel="noopener">http://blog.csdn.net/javazejian/article/details/56267036</a></li>
</ul>
<h1 id="四、可视化埋点"><a href="#四、可视化埋点" class="headerlink" title="四、可视化埋点"></a>四、可视化埋点</h1><p>第三章介绍的是App全埋点，显然这种方式产生的数据太多，无论是对用户资源的节约，还是后续的数据分析都不太好。那么能否<strong>同样借助动态Hook技术，在运行时，只对我们感兴趣的控件进行埋点呢？</strong>这就是可视化埋点。</p>
<h2 id="4-1-可视化埋点原理"><a href="#4-1-可视化埋点原理" class="headerlink" title="4.1 可视化埋点原理"></a>4.1 可视化埋点原理</h2><p>可视化埋点，需要经过两个步骤，可以由非技术人员操作完成。</p>
<ul>
<li><strong>第一步：通过可视化工具配置采集的View。</strong>例如使用已经嵌入了SDK的App连接管理界面，当手机App与后台同步时，后台管理界面上会显示和手机App一样的界面，用户可以在管理界面上用鼠标选择需要监测的元素，设置事件名称，保存这个配置。（也有一些SDK，比如GrowingIO的SDK圈选操作是在手机悬浮了一个原点，拖动圆点到需要监测的元素上来设置埋点位置的，不管是什么方式本质上是一样的，需要保存一份配置到后台）。</li>
<li><strong>第二步：App解析配置，找到View，Hook它的事件并上报数据。</strong>例如嵌入了SDK的App启动时，会从服务器获取到一份配置，再根据这份配置去检测App中的界面及其元素，满足配置的条件时向服务器上报事件。</li>
</ul>
<p>这里面最重要的技术点就是如何把手机上需要埋点的元素记录下来，然后根据配置信息找到需要埋点的控件，再替换这个控件的交互事件处理方法（如点击、长按等）。下面以Mixpanel、SensorsdataSDK为例（这两个SDK实现是一样的），简单分析一下技术方案的实现。</p>
<h2 id="4-2-可视化埋点实现"><a href="#4-2-可视化埋点实现" class="headerlink" title="4.2 可视化埋点实现"></a>4.2 可视化埋点实现</h2><h3 id="4-2-1-圈选需要监测的View，保存配置"><a href="#4-2-1-圈选需要监测的View，保存配置" class="headerlink" title="4.2.1 圈选需要监测的View，保存配置"></a>4.2.1 圈选需要监测的View，保存配置</h3><h4 id="4-2-1-1-创建WebSocket连接后台"><a href="#4-2-1-1-创建WebSocket连接后台" class="headerlink" title="4.2.1.1 创建WebSocket连接后台"></a>4.2.1.1 创建WebSocket连接后台</h4><p>采用WebSocket连接是因为要让手机和后台长时间保持连接，是一个<strong>持续的、实时的双向通信</strong>，WebSocket正适合这种场景。</p>
<p>在Mixpanel和神策SDK里面其实都用到了开源的<a href="https://github.com/TooTallNate/Java-WebSocket" target="_blank" rel="noopener">Java-WebSocket</a>实现。此外，还有一个非常著名的Android同屏工具<a href="https://www.vysor.io/" target="_blank" rel="noopener">Vysor</a>，里面也有一个基于WebSocket的网络框架<a href="https://github.com/koush/AndroidAsync" target="_blank" rel="noopener">AndroidAsync</a>。如果对WebSocket感兴趣，可以看看它们。这里其实只要是用Java实现的WebSocket通信就行。</p>
<h4 id="4-2-1-2-把App界面截图和里面的子View信息发送到后台"><a href="#4-2-1-2-把App界面截图和里面的子View信息发送到后台" class="headerlink" title="4.2.1.2 把App界面截图和里面的子View信息发送到后台"></a>4.2.1.2 把App界面截图和里面的子View信息发送到后台</h4><p>创建WebSocket连接后，SDK会在主线程中，对App中启动的Activity进行扫描，找到界面的RootView（其实是DecorView）。在查找RootView的同时，会采用反射调用View类<code>createSnapshot</code>方法对RootView进行截图，从而实现了对屏幕的截图。</p>
<p>截图之后，SDK内部会判断图片的hash值，如果图片发生了变化，会采用<strong>先序</strong>的方式遍历Activity的ViewTree，遍历同时读取View的属性（id、top、left、width、height、class名称、layoutRules等等）。下面举一个栗子：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fn1f3fcrrkj30rs06twfj.jpg" alt=""></p>
<p>一个简单的Activity，ContentView里面有一个LineaLayout，LinearLayout里面放了一个Button。先序遍历Activity的ViewTree后，SDK会把下面这些数据传到WebSocket的服务器（数据有点多，大概有13k，数据主要来自截图）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"snapshot_response"</span>, </span><br><span class="line">    <span class="attr">"payload"</span>: &#123;</span><br><span class="line">        <span class="attr">"activities"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"activity"</span>: <span class="string">"com.sensorsdata.analytics.android.demo.MainActivity"</span>, </span><br><span class="line">                <span class="attr">"scale"</span>: <span class="number">0.3809524</span>, </span><br><span class="line">                <span class="attr">"serialized_objects"</span>: &#123;</span><br><span class="line">                    <span class="attr">"rootObject"</span>: <span class="number">88528516</span>, </span><br><span class="line">                    <span class="attr">"objects"</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">88528516</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">-1</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">-1</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">1920</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"com.android.internal.policy.DecorView"</span>, </span><br><span class="line">                                <span class="string">"android.widget.FrameLayout"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [</span><br><span class="line">                                <span class="number">57495077</span>, </span><br><span class="line">                                <span class="number">150453242</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">57495077</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">16908822</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">1920</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"com.android.internal.widget.ActionBarOverlayLayout"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [</span><br><span class="line">                                <span class="number">12620808</span>, </span><br><span class="line">                                <span class="number">88713121</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">12620808</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">16908290</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="string">"android:content"</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">210</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">1710</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.widget.FrameLayout"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [</span><br><span class="line">                                <span class="number">150314438</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">150314438</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">-1</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">1710</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.widget.LinearLayout"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [</span><br><span class="line">                                <span class="number">104340701</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">104340701</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">2131427422</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="string">"buttonTest"</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">126</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.widget.Button"</span>, </span><br><span class="line">                                <span class="string">"android.widget.TextView"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [ ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">88713121</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">16908669</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">63</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">147</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"com.android.internal.widget.ActionBarContainer"</span>, </span><br><span class="line">                                <span class="string">"android.widget.FrameLayout"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [</span><br><span class="line">                                <span class="number">164355104</span>, </span><br><span class="line">                                <span class="number">161393113</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">164355104</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">16908668</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">147</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.widget.Toolbar"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [</span><br><span class="line">                                <span class="number">222758006</span>, </span><br><span class="line">                                <span class="number">64817783</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">222758006</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">-1</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">38</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">42</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">553</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">71</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.widget.TextView"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [ ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">64817783</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">-1</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">147</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.widget.ActionMenuView"</span>, </span><br><span class="line">                                <span class="string">"android.widget.LinearLayout"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [ ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">161393113</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">16908673</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="literal">null</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">8</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"com.android.internal.widget.ActionBarContextView"</span>, </span><br><span class="line">                                <span class="string">"com.android.internal.widget.AbsActionBarView"</span>, </span><br><span class="line">                                <span class="string">"android.view.ViewGroup"</span>, </span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [ ]</span><br><span class="line">                        &#125;, </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"hashCode"</span>: <span class="number">150453242</span>, </span><br><span class="line">                            <span class="attr">"id"</span>: <span class="number">16908335</span>, </span><br><span class="line">                            <span class="attr">"index"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"sa_id_name"</span>: <span class="string">"android:statusBarBackground"</span>, </span><br><span class="line">                            <span class="attr">"top"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"left"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"width"</span>: <span class="number">1080</span>, </span><br><span class="line">                            <span class="attr">"height"</span>: <span class="number">63</span>, </span><br><span class="line">                            <span class="attr">"scrollX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"scrollY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"visibility"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationX"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"translationY"</span>: <span class="number">0</span>, </span><br><span class="line">                            <span class="attr">"classes"</span>: [</span><br><span class="line">                                <span class="string">"android.view.View"</span></span><br><span class="line">                            ], </span><br><span class="line">                            <span class="attr">"subviews"</span>: [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;, </span><br><span class="line">                <span class="attr">"image_hash"</span>: <span class="string">"785C4DC3B01B4AFA56BA0E3A56CE8657"</span>, </span><br><span class="line">                <span class="attr">"screenshot"</span>: <span class="string">"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fMttK5ojA0AORQNyKBqQQ9GAHIoG5FA0IIeiATkUDcihaEAORQNyKBrw7TZw4MZfc9nxuU6AbzVjNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuRQNCCHogE5FA3IoWhADkUDcigakEPRgByKBuT4f1ZVvXKwGu9EAAAAAElFTkSuQmCC"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ], </span><br><span class="line">        <span class="attr">"snapshot_time_millis"</span>: <span class="number">403</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后面的<code>screenshot</code>就是手机的截图，以base64编码。</p>
<blockquote>
<p><strong>为了简化分析，在上面的数据里面没有体现View的一些属性，例如Button上显示的text文字，实际上在遍历ViewTree里面每一个View的同时也会上报这个信息，因为我们的Activity和里面View大部分情况下都会是复用的，一个购物的Activity界面，里面的按钮可以显示不同的文字，我们需要统计不同商品的点击次数，就必须要知道按钮上显示的文字是什么。</strong></p>
</blockquote>
<p>对于View来讲，关键信息有这些：</p>
<ul>
<li>activity：Activity类名</li>
<li>hashcode：view的hashcode</li>
<li>id：在Apk中的id</li>
<li>index：在父控件中的同类元素的顺序，如果是根View，那么为-1，如果父View没有多个同类型的子View，那么为0（例如LinearLayout中只有一个Button）</li>
<li>sa_id_name：在Apk中的控件的id的字符串名称，例如android:id=”@+id/button2”，结果就是<code>button2</code></li>
<li>top：距离屏幕上边距</li>
<li>left：距离屏幕的左边距</li>
<li>width：宽</li>
<li>height：高</li>
<li>classes：View自身以及所有的父类类名，是一个数组，这里决定了一个View到底可以有哪些交互，比如点击、长按等</li>
<li>subviews：子View的hashcode，是一个数组</li>
</ul>
<h4 id="4-2-1-3-保存待监测的元素的关键信息"><a href="#4-2-1-3-保存待监测的元素的关键信息" class="headerlink" title="4.2.1.3 保存待监测的元素的关键信息"></a>4.2.1.3 保存待监测的元素的关键信息</h4><p>将上面收集到数据发送到连接的WebSocket后台，由后台解析之后，可以把App界面的截图展示在Web页面。然后把可以监测的元素以方框的形式添加在界面上提示用户（web页面实现时，我推测只需要用到这个View的left、top、width、height属性在html上加一个div标签，然后设置一个有颜色的border属性即可）。用户可以在这个Web页面点击需要监测的元素，设置这个元素的事件名称（event_type和event_name），点击保存。保存一个需要监测的元素时，需要保存这个元素在当前Activity的ViewTree的路径<code>path</code>，以及这个View在父控件中的<code>index</code>，具体有下面几个信息：</p>
<ul>
<li>target_activity：View所在的Activity类名</li>
<li>event_type：事件类型，例如点击事件</li>
<li>event_name：事件名称</li>
<li>trigger_id：事件id</li>
<li>path：View在ViewTree中查找路径<ul>
<li>prefix：表示是否需要监测这个View的兄弟元素，当为<code>shortest</code>时，表示只匹配到索引为index那一个元素，否则匹配所有的父控件下面所有的同类子元素</li>
<li>view_class：view的类名</li>
<li>index：View在父控件中同类元素的下标索引，<strong>这个属性一定程序上可以对抗ViewTree的更新导致的元素监测失效问题，因为父控件加入一个不同类的元素时，index的值不会发生改变</strong></li>
<li>id：View在Apk中的id</li>
<li>sa_id_name：View在Apk中的id的字符串名称</li>
</ul>
</li>
</ul>
<h3 id="4-2-2-获取配置，查找View，监测View的行为后上报事件"><a href="#4-2-2-获取配置，查找View，监测View的行为后上报事件" class="headerlink" title="4.2.2 获取配置，查找View，监测View的行为后上报事件"></a>4.2.2 获取配置，查找View，监测View的行为后上报事件</h3><h4 id="4-2-2-1-获取配置，查找View"><a href="#4-2-2-1-获取配置，查找View" class="headerlink" title="4.2.2.1 获取配置，查找View"></a>4.2.2.1 获取配置，查找View</h4><p>SDK启动时，会从服务器拉取一份JSON格式的配置，保存到sharedPreference里，同时SDK会扫描<code>android.R</code>文件里面的资源id和资源的name并缓存起来。</p>
<p>SDK得到配置之后，解析成JSON对象，读取<code>event_bindings</code>字段，再进一步读取<code>events</code>字段，这个字段下面包含了一个数组，数组的每个元素都描述了一类事件，并包含了这类事件需要监测的元素所在的Activity和元素的路径。这份配置基本上是这样的一个结构：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">event_bindings: &#123;</span><br><span class="line">    events:[</span><br><span class="line">        &#123;</span><br><span class="line">            target_activity: ""</span><br><span class="line">            event_name: "",</span><br><span class="line">            event_type: "",</span><br><span class="line">            ...</span><br><span class="line">            path: [</span><br><span class="line">                &#123;</span><br><span class="line">                    prefix:</span><br><span class="line">                    view_class:</span><br><span class="line">                    index:</span><br><span class="line">                    id:</span><br><span class="line">                    sa_id_name:</span><br><span class="line">                &#125;, </span><br><span class="line">                &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>收到了这份配置之后，SDK会把根据每个event信息，生成一个<code>ViewVisitor</code>。<code>ViewVisitor</code>的作用就是把<code>path</code>数组里面指向的所有View元素都找到，并且根据event_type，<strong>给这个View设置相应的行为监测器</strong>，当这个View发生指定行为时，监测器就会监测到，并上报行为。</p>
<p>在生成ViewVisitor之后，SDK内部是以<code>Map&lt;activity, ViewVisitor&gt;</code>结构保存它们的，这也比较容易理解，毕竟我们的界面是随着一个一个的Activity被create，onResume之后才被用户看见的嘛。在ViewVisitor对象中还有一个<code>PathFinder</code>对象，这个对象负责在ViewTree中根据path去查找View（这里其实是在一个tree里面查找node的问题）。</p>
<h4 id="4-2-2-2-监测View的行为，上报事件"><a href="#4-2-2-2-监测View的行为，上报事件" class="headerlink" title="4.2.2.2 监测View的行为，上报事件"></a>4.2.2.2 监测View的行为，上报事件</h4><p><code>ViewVisitor</code>是怎么给View设置监听器，监测元素的产生的行为呢？<strong>答案就是<code>View.AccessibilityDelegate</code>。</strong></p>
<p>在Android SDK里面，AccessibilityService（无障碍服务）为我们提供了一系列的事件回调，帮助我们指示一些用户界面的状态变化。我们可以派生辅助功能类，进而对不同的AccessibilityEvent进行处理，我们看下AccessibilityEvent里面有哪些事件类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents the event of clicking on a &#123;<span class="doctag">@link</span> android.view.View&#125; like</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> android.widget.Button&#125;, &#123;<span class="doctag">@link</span> android.widget.CompoundButton&#125;, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_VIEW_CLICKED = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents the event of long clicking on a &#123;<span class="doctag">@link</span> android.view.View&#125; like</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> android.widget.Button&#125;, &#123;<span class="doctag">@link</span> android.widget.CompoundButton&#125;, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_VIEW_LONG_CLICKED = <span class="number">0x00000002</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents the event of selecting an item usually in the context of an</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> android.widget.AdapterView&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_VIEW_SELECTED = <span class="number">0x00000004</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents the event of setting input focus of a &#123;<span class="doctag">@link</span> android.view.View&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_VIEW_FOCUSED = <span class="number">0x00000008</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents the event of changing the text of an &#123;<span class="doctag">@link</span> android.widget.EditText&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_VIEW_TEXT_CHANGED = <span class="number">0x00000010</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>以点击事件<code>TYPE_VIEW_CLICKED</code>为例</strong>，当Activity界面的RootView开始绘制的时候（ViewTreeObserver.OnGlobalLayoutListener的onGlobalLayout回调时），ViewVisitor也会开始寻找指定的View，并给这个View设置新的AccessibilityDelegate。简单看一下这个新的View.AccessibilityDelegate是怎么写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TrackingAccessibilityDelegate</span> <span class="keyword">extends</span> <span class="title">View</span>.<span class="title">AccessibilityDelegate</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">TrackingAccessibilityDelegate</span><span class="params">(View.AccessibilityDelegate realDelegate)</span> </span>&#123;</span><br><span class="line">                mRealDelegate = realDelegate;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> View.<span class="function">AccessibilityDelegate <span class="title">getRealDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRealDelegate;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAccessibilityEvent</span><span class="params">(View host, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == mEventType) &#123;</span><br><span class="line">                    fireEvent(host); <span class="comment">// 事件上报</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != mRealDelegate) &#123;</span><br><span class="line">                    mRealDelegate.sendAccessibilityEvent(host, eventType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> View.AccessibilityDelegate mRealDelegate;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>可以看到在SDK的<code>TrackingAccessibilityDelegate#sendAccessibilityEvent</code>方法里面，发出了事件上报。</p>
<p>这么说View的点击处理方法中应该要调用<code>sendAccessibilityEvent</code>才行，那么View在点击方法的内部实现里有调用<code>sendAccessibilityEvent</code>方法吗？看一下View处理点击事件 - <code>View.performClick</code>的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> result;</span><br><span class="line">    <span class="keyword">final</span> ListenerInfo li = mListenerInfo;</span><br><span class="line">    <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">        playSoundEffect(SoundEffectConstants.CLICK);</span><br><span class="line">        li.mOnClickListener.onClick(<span class="keyword">this</span>);</span><br><span class="line">        result = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAccessibilityEvent</span><span class="params">(<span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAccessibilityDelegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mAccessibilityDelegate.sendAccessibilityEvent(<span class="keyword">this</span>, eventType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sendAccessibilityEventInternal(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessibilityDelegate</span><span class="params">(@Nullable AccessibilityDelegate delegate)</span> </span>&#123;</span><br><span class="line">    mAccessibilityDelegate = delegate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由此可见View的点击处理内部确实调用到了<code>sendAccessibilityEvent</code>，所以在RootView开始绘制的时候，给View注册AccessibilityDelegate可以监测到它的点击事件。可视化埋点这里对View的事件监测也是一种<strong>“动态Hook”</strong>的实现，不过没有采用第三章中介绍的反射获取OnClickListener的方案，而是采用了获取AccessibilityDelegate来实现，这种方式反射次数少一些，效率上会更好一些。</p>
<blockquote>
<p>在网上看到有网友提出，setAccessibilityDelegate来监测View的点击对大多数厂商的机型和版本都是可以的，但是有部分机型是无法成功捕获监控到点击事件。从View的标识生成，以及监测原理来讲，这个方案的稳定性存在一些疑问。</p>
</blockquote>
<h2 id="4-3-可视化埋点的难点和优化"><a href="#4-3-可视化埋点的难点和优化" class="headerlink" title="4.3 可视化埋点的难点和优化"></a>4.3 可视化埋点的难点和优化</h2><p>上面简单分析了Mixpanel和SensorsSDK可视化埋点的基本实现，里面最重要有一个技术点值得仔细琢磨，那就是<strong>如何唯一标识App中的一个View？由于View是长在ViewTree上的一个节点，那么用纵向的路径，以及横向的下标应该可以标识一个View。</strong></p>
<ul>
<li>纵向的路径：是指从根View到这个View的父控件的路径上经过的每一个节点</li>
<li>横向的下标：是指这个View在父控件中的同类元素的下标索引（例如一个LinearLayout中有两个Button，那么第一个Button的下标就是0，第二个Button的下标就是1，这种方式可以抵抗父控件中加入一个非Button类型的元素时对ViewTree的改变，保证仍然可以找到Button，但是无法抵抗父控件中加入同类型的元素）</li>
</ul>
<p>上面仅仅提到了标识一个View的基本方法，但是有很多实际场景，会对View的查找造成毁灭性的影响，例如界面中Fragment的变化，ViewTree的变化，ListView中控件的复用等等，这里有两篇网易的博客，里面对一些场景的优化做了详细地说明，可以仔细看看：</p>
<ul>
<li><a href="http://www.infoq.com/cn/presentations/netease-happy-to-no-burial-point-data-collection-practice-road" target="_blank" rel="noopener">http://www.infoq.com/cn/presentations/netease-happy-to-no-burial-point-data-collection-practice-road</a></li>
<li><a href="http://www.jianshu.com/p/b5ffe845fe2d" target="_blank" rel="noopener">http://www.jianshu.com/p/b5ffe845fe2d</a></li>
</ul>
<h2 id="4-4-可视化埋点参考资料"><a href="#4-4-可视化埋点参考资料" class="headerlink" title="4.4 可视化埋点参考资料"></a>4.4 可视化埋点参考资料</h2><ul>
<li>sensorsdata git，包含了Android、iOS、js、JAVA等多个版本的SDK：<a href="https://github.com/sensorsdata" target="_blank" rel="noopener">https://github.com/sensorsdata</a></li>
<li>Mixpanel git，包含了Android、iOS、js、JAVA等多个版本的SDK：<a href="https://github.com/mixpanel" target="_blank" rel="noopener">https://github.com/mixpanel</a></li>
<li>网易移动端数据收集和分析博客：<a href="http://www.jianshu.com/c/ee326e36f556" target="_blank" rel="noopener">http://www.jianshu.com/c/ee326e36f556</a></li>
<li>美团点评前端无痕埋点实践：<a href="https://tech.meituan.com/mt-mobile-analytics-practice.html" target="_blank" rel="noopener">https://tech.meituan.com/mt-mobile-analytics-practice.html</a></li>
</ul>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>最后简单总结一下几种方案的优缺点和使用场景，在实际应用中多种方式配合使用，平衡效率和可靠性，适合自己的业务才是最好的。</p>
<table>
<thead>
<tr>
<th style="text-align:center">埋点方案</th>
<th style="text-align:left">优点</th>
<th style="text-align:left">缺点</th>
<th style="text-align:left">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">代码埋点</td>
<td style="text-align:left">1.使用灵活，精确控制发送时机 <br> 2.方便设置自定义业务相关的属性</td>
<td style="text-align:left">1.埋点成本高，工作量大，必须是技术人员才能完成 <br> 2.更新成本高，一旦上线很难修改。只能通过热修复或者重新发版 <br> 3.对业务代码的侵入大</td>
<td style="text-align:left">对业务上下文理解要求较高的业务数据，如电商购物这类可能经过多次页面跳转，埋点时还需要带上前面页面中的一些信息</td>
</tr>
<tr>
<td style="text-align:center">全埋点</td>
<td style="text-align:left">1.开发、维护成本低 <br> 2.可以追溯历史数据 <br> 3.对业务代码侵入小 <br> 4.可以收集到一些额外信息，例如界面的热力图</td>
<td style="text-align:left">1.高额流量和计算成本 <br> 2.无法灵活收集属性 <br> 3.动态的Hook方式支持的控件有限、事件类型有限，大量事件监测时反射对App运行性能有影响 <br> 4.静态的Hook方式需要第三方编译器参与，打包时间增长</td>
<td style="text-align:left">上下文相对独立的、通用的数据，如点击热力图，性能监控和日志</td>
</tr>
<tr>
<td style="text-align:center">可视化埋点</td>
<td style="text-align:left">1.开发、维护成本低 <br> 2.可以按需埋点，灵活性好 <br> 3.对业务代码侵入小</td>
<td style="text-align:left">1.界面的结构发生变化时，圈选的待监测元素可能会失效 <br> 2.支持的控件和事件类型有限 <br> 3.无法灵活地收集到上下文属性</td>
<td style="text-align:left">上下文相对简单，依靠控件可以获得上下文信息，界面结构比较简单固定，如新闻阅读、游戏分享界面</td>
</tr>
</tbody>
</table>

      
    </div>

    <div>    
    
    
    <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>本文作者：</strong>unclechen
    </li>
    <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="/2017/12/18/Android埋点技术分析/" title="Android埋点技术分析">2017/12/18/Android埋点技术分析/</a>
    </li>
    <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本文采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a>进行许可。转载请注明出处！
    </li>
    </ul>
    
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/SDK/" rel="tag"># SDK</a>
          
            <a href="/tags/埋点/" rel="tag"># 埋点</a>
          
            <a href="/tags/无埋点/" rel="tag"># 无埋点</a>
          
            <a href="/tags/可视化埋点/" rel="tag"># 可视化埋点</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/15/Android混合开发之WebView中使用原生组件替换标签元素/" rel="next" title="Android混合开发之——WebView中使用原生组件替换标签元素">
                <i class="fa fa-chevron-left"></i> Android混合开发之——WebView中使用原生组件替换标签元素
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/24/JS埋点技术分析/" rel="prev" title="JS埋点技术分析">
                JS埋点技术分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
    <div id="gitalk-container"></div>
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="unclechen" />
          <p class="site-author-name" itemprop="name">unclechen</p>
           
              <p class="site-description motion-element" itemprop="description">吃下恶魔果实，我就能变成超级赛亚人！</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/unclechen" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1718455407" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、概念"><span class="nav-text">一、概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、代码埋点"><span class="nav-text">二、代码埋点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、全埋点"><span class="nav-text">三、全埋点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-基本原理"><span class="nav-text">3.1 基本原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-使用AspectJ做静态Hook"><span class="nav-text">3.2 使用AspectJ做静态Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-AspectJ基本概念"><span class="nav-text">3.2.1 AspectJ基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-实现"><span class="nav-text">3.2.2 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-1-定义一个Aspect"><span class="nav-text">3.2.2.1 定义一个Aspect</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-2-使用ajc编译器向源代码中“织入”Aspect代码"><span class="nav-text">3.2.2.2 使用ajc编译器向源代码中“织入”Aspect代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-3-查看织入后的class文件"><span class="nav-text">3.2.2.3 查看织入后的class文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-使用代理模式实现动态Hook"><span class="nav-text">3.3 使用代理模式实现动态Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-代理模式"><span class="nav-text">3.3.1 代理模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-实现"><span class="nav-text">3.3.2 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-1-创建点击监听器的代理类"><span class="nav-text">3.3.2.1 创建点击监听器的代理类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-2-反射获取一个View的mListenerInfo-mOnClickListener，替换成代理的点击监听器"><span class="nav-text">3.3.2.2 反射获取一个View的mListenerInfo.mOnClickListener，替换成代理的点击监听器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-3-对App中所有的View进行动态Hook"><span class="nav-text">3.3.2.3 对App中所有的View进行动态Hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-动态Hook小结"><span class="nav-text">3.3.3 动态Hook小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-全埋点参考资料"><span class="nav-text">3.4 全埋点参考资料</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、可视化埋点"><span class="nav-text">四、可视化埋点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-可视化埋点原理"><span class="nav-text">4.1 可视化埋点原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-可视化埋点实现"><span class="nav-text">4.2 可视化埋点实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-圈选需要监测的View，保存配置"><span class="nav-text">4.2.1 圈选需要监测的View，保存配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-1-创建WebSocket连接后台"><span class="nav-text">4.2.1.1 创建WebSocket连接后台</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-2-把App界面截图和里面的子View信息发送到后台"><span class="nav-text">4.2.1.2 把App界面截图和里面的子View信息发送到后台</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-3-保存待监测的元素的关键信息"><span class="nav-text">4.2.1.3 保存待监测的元素的关键信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-获取配置，查找View，监测View的行为后上报事件"><span class="nav-text">4.2.2 获取配置，查找View，监测View的行为后上报事件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-1-获取配置，查找View"><span class="nav-text">4.2.2.1 获取配置，查找View</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-2-监测View的行为，上报事件"><span class="nav-text">4.2.2.2 监测View的行为，上报事件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-可视化埋点的难点和优化"><span class="nav-text">4.3 可视化埋点的难点和优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-可视化埋点参考资料"><span class="nav-text">4.4 可视化埋点参考资料</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、总结"><span class="nav-text">五、总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">unclechen</span>
</div>


<!--
<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>
-->


        

        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "071293399566469d925f180d68952611",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.js"></script>
  <script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: 'a11668e1882acefd3ff5',
        clientSecret: '0c20ad42eb72f7677c7fb68fd25710a4edbd5ece',
        repo: 'blog_comment_repo',
        owner: 'unclechen',
        admin: ['unclechen'],
        id: md5(location.pathname),
        distractionFreeMode: 'true'
      })
      gitalk.render('gitalk-container')
  </script>


  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  

  

  

  

</body>
</html>
